Ext.application({name:"PT",paths:{PT:"resources/app"},controllers:["NavController"],autoCreateViewport:true});String.prototype.insert=function(b,a){if(b>0){return this.substring(0,b)+a+this.substring(b,this.length)}else{return a+this}};Ext.define("PT.controller.NavController",{extend:"Ext.app.Controller",refs:[{ref:"navview",selector:"navview"},{ref:"mainContent",selector:"mainContent"}],init:function(){var a=this;a.control({"viewport > panel":{afterlayout:this.onPanelRendered}});a.control({navview:{tabchange:a.onNavTabchange}})},onPanelRendered:function(){},onLaunch:function(){},onSideBarSelectionChange:function(a,b){if(b.length){this.showView(b[0])}},onNavItemsStoreLoad:function(b,a){Ext.defer(function(){if(a.length){var c=a[0],d=this;d.getNavsidebar().getSelectionModel().select(c)}},500,this)},onNavTabchange:function(d,a,c,b){this.getNavItemsStore().load({params:{ref:a.key}});this.getNavsidebar().bindStore(this.getNavItemsStore())},showView:function(b){var a=this.getMainContent();if(a!=null){if(b.data.value!=""){a.removeAll();a.add(Ext.create(b.data.value))}else{alert("配置参数错误")}}},clickNodeChange:function(g,e,d){var f=e[0];if(!f){return}if(f.isLeaf()){var c=f.data.url;var b=f.data.view;var a=null;if(c&&c!==""){a={title:f.data.text,id:f.data.name,iconCls:"tabs",html:"加载失败!",autoLoad:{url:f.data.url,scripts:true},closable:true};this.openTab(a)}else{if(b&&b!=""){a={title:f.data.text,id:f.data.name,iconCls:"tabs",items:[Ext.create(f.data.view)],closable:true};this.openTab(a)}else{alert("导航树参数配置错误！")}}}else{f.expand()}},openTab:function(a,e){tabContent=this.getViewer();var d=(typeof a=="string"?a:e||a.id);var b=Ext.getCmp(d);if(b){tabContent.setActiveTab(b)}else{if(typeof a!="string"){a.id=d;var c=tabContent.add(a);tabContent.setActiveTab(c)}}}});Ext.define("PT.model.ImageModel",{extend:"Ext.data.Model",fields:["name","id","url","tooltip","thumb_url"]});Ext.define("PT.store.RoleType",{extend:"Ext.data.Store",fields:["value","name"],data:[{value:1,name:"管理员"},{value:2,name:"测试员"},{value:3,name:"操作员"}]});Ext.define("PT.store.TaskType",{extend:"Ext.data.Store",fields:["value","name"],data:[{value:"D",name:"定点CQT测试"}]});Ext.define("PT.view.MainContent",{extend:"Ext.panel.Panel",region:"center",margins:"5 5 5 0",id:"mainContent",alias:"widget.mainContent",cls:"empty",layout:"fit",bodyStyle:"background:#f1f1f1",html:"<br/><br/>&lt;这是个空页&gt;"});Ext.define("PT.view.NavView",{extend:"Ext.panel.Panel",requires:["Ext.data.*","Ext.util.*","Ext.view.View"],title:"操作管理",alias:"widget.navview",split:true,width:250,minWidth:200,maxWidth:400,collapsible:false,animCollapse:true,margins:"0 0 0 3",layout:"accordion",initComponent:function(){var a=this;Ext.applyIf(a,{items:[{title:"任务管理",id:"monitor_menu",cls:"images-view",frame:true,iconCls:"info"},{title:"统计分析",id:"report_menu",cls:"images-view",frame:true,iconCls:"report"},{title:"用户中心",id:"userCenter_menu",cls:"images-view",frame:true,iconCls:"user"}]});a.callParent(arguments);a.on("boxready",a.on_boxready)},on_boxready:function(f,e,b,d){Ext.define("ImageModel",{extend:"Ext.data.Model",fields:["name","id","url","tooltip","thumb_url"]});var c=Ext.create("Ext.data.Store",{model:"ImageModel",autoLoad:false,proxy:{type:"ajax",url:"resources/data/MonitorMenu.json",reader:{type:"json",root:"images"}}});c.load({scope:this,callback:function(j,i,k){var h=Ext.getCmp("monitor_menu");h.add(f.initDataView(c))}});var g=Ext.create("Ext.data.Store",{model:"ImageModel",autoLoad:false,proxy:{type:"ajax",url:"resources/data/ReportMenu.json",reader:{type:"json",root:"images"}}});g.load({scope:this,callback:function(i,h,k){var j=Ext.getCmp("report_menu");j.add(f.initDataView(g))}});var a=Ext.create("Ext.data.Store",{model:"ImageModel",autoLoad:false,proxy:{type:"ajax",url:"resources/data/UserMenu.json",reader:{type:"json",root:"images"}}});a.load({scope:this,callback:function(i,h,k){var j=Ext.getCmp("userCenter_menu");j.add(f.initDataView(a))}})},initDataView:function(b){var a=Ext.create("Ext.view.View",{store:b,tpl:['<tpl for=".">','<div class="thumb-wrap" id="{name}">','<div class="thumb"><img  src="{thumb_url}" title="{tooltip}"></div>','<span class="x-editable">{name}</span></div>',"</tpl>",'<div class="x-clear"></div>'],multiSelect:false,trackOver:true,overItemCls:"x-item-over",itemSelector:"div.thumb-wrap",emptyText:"没有数据显示...",listeners:{itemclick:function(e,c){if(c==null){return}var f=c.getData();var d=Ext.getCmp("mainContent");if(d!=null){if(f.url!=""){d.removeAll();d.add(Ext.create(f.url))}else{alert("配置参数错误")}}}}});return a}});Ext.define("PT.view.Viewport",{extend:"Ext.container.Viewport",requires:["PT.view.NavView","Ext.layout.container.Border"],layout:"border",items:[{region:"north",margins:"0 0 0 0",contentEl:"north",border:false,height:60,bodyStyle:""},{region:"west",xtype:"navview"},{region:"center",margins:"0 5 5 5",layout:"border",border:true,items:[Ext.create("PT.view.MainContent")]}]});Ext.define("PT.view.report.ResultPanel",{extend:"Ext.panel.Panel",ids:null,viewConfig:{stripeRows:true},initComponent:function(){var d=this;var b=Ext.create("Ext.form.Panel",{region:"north",fieldDefaults:{msgTarget:"side",labelAlign:"right",labelWidth:105},defaults:{anchor:"100%"},items:[{collapsible:true,collapsed:false,bodyStyle:"padding:5px",title:"检索条件",defaultType:"textfield",layout:"anchor",defaults:{anchor:"50%"},items:[{fieldLabel:'<span style="color: #f00">*</span>开始时间',xtype:"fieldcontainer",anchor:"100%",layout:"hbox",items:[{xtype:"datefield",name:"txt_begin_date",format:"Y-m-d",value:new Date(),allowBlank:false},{xtype:"timefield",name:"txt_begin_time",format:"H:i:s",value:"00:00:00",allowBlank:false}]},{fieldLabel:'<span style="color: #f00">*</span>结束时间',xtype:"fieldcontainer",anchor:"100%",layout:"hbox",items:[{xtype:"datefield",name:"txt_end_date",format:"Y-m-d",value:new Date(),allowBlank:false},{xtype:"timefield",name:"txt_end_time",format:"H:i:s",value:"23:59:59",allowBlank:false}]},{xtype:"container",layout:"column",anchor:"0",items:[{xtype:"container",columnWidth:0.3,items:[{xtype:"textfield",fieldLabel:"任务",maxLength:11,name:"txt_phone"}]}]}],buttons:[{text:"检索",handler:function(){a()}},{text:"清空",handler:function(){var f=this.up("form").getForm();f.reset();a()}}]}]});var e=Ext.create("Ext.data.Store",{fields:[{name:"id",type:"int"},"fileName","index","beginDateTime","endDateTime","testResult","pointIndex","lac","rxlvl","cqt","callResult"],proxy:{type:"ajax",url:"testResult",reader:{type:"json",root:"rows"}}});var a=function(){var j=b.getForm();var f=j.findField("txt_phone").getValue();var h=j.findField("txt_begin_date").value;var k=Ext.Date.format(h,"Ymd");h=j.findField("txt_begin_time").getValue();var g=Ext.Date.format(h,"His");h=j.findField("txt_end_date").getValue();var l=Ext.Date.format(h,"Ymd");h=j.findField("txt_end_time").getValue();var i=Ext.Date.format(h,"His");e.on("beforeload",function(m,n){var o={MobileNum:f,TestBeginTime:k+g,TestEndTime:l+i};Ext.apply(m.proxy.extraParams,o)});e.load({params:{start:0,limit:25}})};var c='<img src="resources/images/icons/fam/accept.png"  border="0">';Ext.applyIf(d,{layout:"border",items:[b,{xtype:"gridpanel",region:"center",store:e,columns:[{header:"点位序号",dataIndex:"pointIndex"},{header:"LAC-CI",dataIndex:"lac"},{header:"RxLvl",dataIndex:"rxlvl"},{header:"CQT质量等级",dataIndex:"cqt",hidden:false},{header:"测试结果",dataIndex:"testResult",renderer:function(f){if(f=="00"){return"成功"}else{return"失败"}}},{text:"接通状态",columns:[{text:"正常",width:75,align:"center",renderer:function(f){if(f=="101"){return c}return""},dataIndex:"callResult"},{text:"噪音",width:75,align:"center",renderer:function(f){if(f=="102"){return c}return""},dataIndex:"callResult"},{text:"串话",width:75,align:"center",renderer:function(f){if(f=="103"){return c}return""},dataIndex:"callResult"},{text:"无话音",width:75,align:"center",renderer:function(f){if(f=="104"){return c}return""},dataIndex:"callResult"},{text:"单通",width:75,align:"center",renderer:function(f){if(f=="105"){return c}return""},dataIndex:"callResult"},{text:"掉话",width:75,align:"center",renderer:function(f){if(f=="106"){return c}return""},dataIndex:"callResult"},{text:"单通",width:75,align:"center",renderer:function(f){if(f=="107"){return c}return""},dataIndex:"callResult"}]},{text:"未接通",columns:[{text:"信道忙",width:75,align:"center",renderer:function(f){if(f=="201"){return c}return""},dataIndex:"callResult"},{text:"无信号",width:75,align:"center",renderer:function(f){if(f=="202"){return c}return""},dataIndex:"callResult"},{text:"无声音中断",width:75,align:"center",renderer:function(f){if(f=="203"){return c}return""},dataIndex:"callResult"},{text:"拨通后立即中断",width:75,align:"center",renderer:function(f){if(f=="204"){return c}return""},dataIndex:"callResult"}]},{header:"测试序号",dataIndex:"index",hidden:true},{header:"呼叫结果 ",dataIndex:"callResult",hidden:true},{header:"测试开始时间",dataIndex:"beginDateTime",flex:1,renderer:function(f){if(f.length==14){return f.insert(12,":").insert(10,":").insert(8," ").insert(6,"-").insert(4,"-")}return f}},{header:"测试结束时间",dataIndex:"endDateTime",flex:1,renderer:function(f){if(f.length==14){return f.insert(12,":").insert(10,":").insert(8," ").insert(6,"-").insert(4,"-")}return f}}],dockedItems:[{xtype:"pagingtoolbar",store:e,dock:"bottom",displayInfo:true}]}]});d.callParent(arguments)}});Ext.define("PT.view.sys.UsersPanel",{extend:"Ext.panel.Panel",ids:null,viewConfig:{stripeRows:true},initComponent:function(){var b=this;var c=Ext.create("Ext.data.Store",{fields:["userName","passWord","remarks","createIP",{name:"createDT",type:"date"},{name:"role",type:"int"}],proxy:{type:"ajax",url:"users",reader:{type:"json",root:"rows"}}});var a=function(){c.load()};Ext.applyIf(b,{layout:"border",items:[{xtype:"gridpanel",region:"center",title:"用户管理",store:c,selModel:Ext.create("Ext.selection.CheckboxModel",{mode:"SIMPLE"}),columns:[{header:"用户名",dataIndex:"userName"},{header:"角色",dataIndex:"role",flex:1,hidden:false,renderer:function(e){var d=Ext.create("PT.store.RoleType").findRecord("value",e);if(d!=null){return d.data.name}return e}},{header:"备注",dataIndex:"remarks",flex:1},{header:"创建时间",dataIndex:"createDT"},{xtype:"actioncolumn",flex:1,items:[{icon:"resources/images/icons/fam/information.png",tooltip:"查看",handler:function(e,g,d){var f=e.getStore().getAt(g);Ext.create("PT.view.window.EditUserWindow",{rec:f,listeners:{beforedestroy:function(){a()}}}).show()}}]}],dockedItems:[{xtype:"toolbar",dock:"top",items:[{text:"添加",tooltip:"添加用户",iconCls:"add",handler:function(){Ext.create("PT.view.window.EditUserWindow",{listeners:{beforedestroy:function(){a()}}}).show()}},{text:"删除",tooltip:"删除用户",iconCls:"del",handler:function(){var d=b.child("grid").getSelectionModel().getSelection();if(d.length==0){alert("请选择要删除用户！");return}var e="";for(var f=0;f<d.length;f++){e+=d[f].data.userName+";"}Ext.Msg.show({title:"信息",msg:"确定要删除选中用户吗？",buttons:Ext.Msg.YESNO,fn:function(h,i,g){if(h=="yes"){Ext.Ajax.request({url:"deleteUser",params:{users:e},success:function(k){var l=k.responseText;var j=Ext.JSON.decode(l);if(j.success){c.load({params:{key:""}})}else{alert(j.msg)}}})}},icon:Ext.window.MessageBox.QUESTION})}},"-",{xtype:"textfield",name:"txt_search_key",emptyText:"请输入要查询用户"},{text:"检索",tooltip:"检索查询用户",iconCls:"search",handler:function(){var d=this.up("toolbar").child("textfield").getValue();c.load({params:{key:d}})}}]}]}]});b.callParent(arguments);c.load()}});Ext.define("PT.view.task.ManagerPanel",{extend:"Ext.panel.Panel",ids:null,viewConfig:{stripeRows:true},initComponent:function(){var a=this;var b=Ext.create("Ext.data.Store",{fields:["task_code","task_type","params",{name:"testTimes",type:"int"},"testUser",{name:"createDt",type:"date"},{name:"status",type:"int"},"locationCode","callType","callTel","callTime","timeout"],proxy:{type:"ajax",url:"getTasks",reader:{type:"json",root:"rows"}}});Ext.applyIf(a,{layout:"border",items:[{xtype:"gridpanel",region:"center",title:"任务管理",selModel:Ext.create("Ext.selection.CheckboxModel",{mode:"SIMPLE"}),store:b,columns:[{header:"任务号",dataIndex:"task_code",flex:1},{header:"类型",dataIndex:"task_type",renderer:function(c){return c}},{header:"楼宇点位",dataIndex:"locationCode",flex:1},{header:"呼叫类型",dataIndex:"callType",flex:1},{header:"主叫/被叫号码",dataIndex:"callTel",flex:1},{header:"通话持续时间",dataIndex:"callTime",flex:1},{header:"次数",dataIndex:"testTimes",flex:1},{header:"状态",dataIndex:"status",renderer:function(c){if(c==0){return"未生效"}else{if(c==1){return"生效"}}return c}},{xtype:"actioncolumn",flex:1,items:[{icon:"resources/images/icons/fam/edit.gif",tooltip:"查看",handler:function(d,f,c){var e=d.getStore().getAt(f)}},{icon:"resources/images/icons/fam/arrow_down.png",tooltip:"立即生效",handler:function(d,f,c){var e=d.getStore().getAt(f);Ext.Msg.show({title:"信息",msg:"确定要设置任务有效吗？",buttons:Ext.Msg.YESNO,fn:function(h,i,g){if(h=="yes"){Ext.Ajax.request({url:"validTask",params:{taskid:e.data.testTaskCode},success:function(k){var l=k.responseText;var j=Ext.JSON.decode(l);if(j.success){b.load({params:{taskType:0}})}else{alert(j.msg)}}})}}})}}]}],dockedItems:[{xtype:"toolbar",dock:"top",items:[{text:"添加",tooltip:"添加测试任务",iconCls:"add",handler:function(){Ext.create("PT.view.window.EditTaskWindow",{listeners:{beforedestroy:function(){b.load({params:{taskType:0}})}}}).show()}},{text:"删除",tooltip:"删除测试任务",iconCls:"del",handler:function(){}}]},{xtype:"pagingtoolbar",store:b,dock:"bottom",displayInfo:true}]}]});a.callParent(arguments);b.load({params:{taskType:0}})}});Ext.define("PT.view.window.EditTaskWindow",{extend:"Ext.window.Window",width:600,height:400,modal:true,rec:null,title:"任务编辑",initComponent:function(){var a=this;var b=Ext.create("Ext.form.Panel",{region:"center",bodyPadding:5,layout:"anchor",fieldDefaults:{labelAlign:"right"},defaults:{anchor:"95%"},defaultType:"textfield",items:[{fieldLabel:"任务号",name:"task_code",anchor:"50%",allowBlank:false},{fieldLabel:"任务类型",name:"task_type",allowBlank:false,xtype:"combobox",store:Ext.create("PT.store.TaskType"),queryMode:"local",displayField:"name",valueField:"value",anchor:"50%"},{fieldLabel:"楼宇点位",name:"locationCode",maxLength:20,allowBlank:false,anchor:"90%"},{xtype:"fieldcontainer",fieldLabel:"呼叫类型",defaultType:"radiofield",defaults:{flex:1},layout:"hbox",anchor:"100%",items:[{boxLabel:"主叫",name:"callType",inputValue:"CL0",checked:true,id:"callType_radio1"},{boxLabel:"被叫",name:"callType",inputValue:"CL1",id:"callType_radio2"}]},{fieldLabel:"主叫/被叫号码",name:"callTel",maxLength:15,allowBlank:false,anchor:"90%"},{fieldLabel:"通话持续时间",name:"callTime",xtype:"numberfield",minValue:0,value:10,allowBlank:false,anchor:"90%"},{fieldLabel:"呼叫超时",name:"timeout",xtype:"numberfield",minValue:0,value:10,allowBlank:false,anchor:"90%"},{fieldLabel:"次数",xtype:"textfield",name:"testTimes",xtype:"numberfield",minValue:0,value:10,anchor:"50%"},{fieldLabel:"测试员",xtype:"textfield",name:"testUser",maxLength:15,allowBlank:false,anchor:"50%"}]});Ext.applyIf(a,{layout:"border",items:[b],dockedItems:[{xtype:"toolbar",dock:"top",items:[{text:"保存",tooltip:"保存添加测试任务",iconCls:"add",handler:function(){var c=a.down("form").getForm();if(c.isValid()){c.submit({url:"submitTask",success:function(d,e){Ext.Msg.alert("Success",e.result.msg);a.close()},failure:function(d,e){Ext.Msg.alert("Failed",e.result.msg)}})}}},{text:"关闭",tooltip:"关闭窗口",iconCls:"add",handler:function(){a.close()}}]}]});a.callParent(arguments);a.on("beforerender",a.on_beforerender)},on_beforerender:function(c,a){var d=c.rec;if(d!=null){var b=c.child("form").getForm();b.loadRecord(d)}}});Ext.define("PT.view.window.EditUserWindow",{extend:"Ext.window.Window",width:600,height:400,modal:true,rec:null,title:"用户信息编辑",initComponent:function(){var a=this;var b=Ext.create("Ext.form.Panel",{region:"center",bodyPadding:5,layout:"anchor",fieldDefaults:{labelAlign:"right"},defaultType:"textfield",items:[{fieldLabel:"用户名",name:"userName",anchor:"50%",allowBlank:false},{fieldLabel:"密码",name:"passWord",allowBlank:false,maxLength:15,blankText:"密码不能为空",inputType:"password",anchor:"50%"},{fieldLabel:"角色",name:"role",allowBlank:false,xtype:"combobox",store:Ext.create("PT.store.RoleType"),queryMode:"local",displayField:"name",valueField:"value",anchor:"50%"},{fieldLabel:"备注",xtype:"textareafield",name:"remarks",anchor:"50%"}]});Ext.applyIf(a,{layout:"border",items:[b],dockedItems:[{xtype:"toolbar",dock:"top",items:[{text:"保存",tooltip:"保存用户信息",iconCls:"add",handler:function(){var c=a.down("form").getForm();if(c.isValid()){c.submit({url:"submitUser",success:function(d,e){Ext.Msg.alert("Success",e.result.msg);a.close()},failure:function(d,e){Ext.Msg.alert("Failed",e.result.msg)}})}}},{text:"关闭",tooltip:"关闭窗口",iconCls:"add",handler:function(){a.close()}}]}]});a.callParent(arguments);a.on("beforerender",a.on_beforerender)},on_beforerender:function(c,a){var d=c.rec;if(d!=null){var b=c.child("form").getForm();b.loadRecord(d)}}});